<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Meteorological Normalisation with {deweather} • deweather</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Meteorological Normalisation with {deweather}">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">deweather</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.2.9102</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/deweather.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bookdown.org/david_carslaw/openair/">Book (External)</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-case-studies-external-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Case Studies (External)</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-case-studies-external-">
<li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/pii/S004896971834244X">(2019) Using meteorological normalisation to detect interventions in air quality time series</a></li>
    <li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/abs/pii/S1352231012001355">(2012) A short-term intervention study — Impact of airport closure due to the eruption of Eyjafjallajökull on near-field air quality</a></li>
    <li><a class="external-link dropdown-item" href="https://www.sciencedirect.com/science/article/abs/pii/S1352231009003069">(2009) Analysis of air pollution data at a mixed source location using boosted regression trees</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/davidcarslaw/deweather/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Meteorological Normalisation with {deweather}</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/davidcarslaw/deweather/blob/master/vignettes/articles/deweather.Rmd" class="external-link"><code>vignettes/articles/deweather.Rmd</code></a></small>
      <div class="d-none name"><code>deweather.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidcarslaw.github.io/deweather/">deweather</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Meteorology plays a central role in affecting the concentrations of
pollutants in the atmosphere. When considering trends in air pollutants
it can be very difficult to know whether a change in concentration is
due to emissions or meteorology.</p>
<p>The <strong>deweather</strong> package uses a powerful statistical
technique based on <em>boosted regression trees</em> using the
<a href="https://github.com/gbm-developers/gbm" class="external-link">gbm</a> package <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Ridgeway G, Developers G (2024). &lt;em&gt;gbm: Generalized
Boosted Regression Models&lt;/em&gt;. R package version 2.2.2, &lt;a href="https://CRAN.R-project.org/package=gbm" class="external-link uri"&gt;https://CRAN.R-project.org/package=gbm&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>. Statistical models are developed to
explain concentrations using meteorological and other variables. These
models can be tested on randomly withheld data with the aim of
developing the most appropriate model.</p>
</div>
<div class="section level2">
<h2 id="example-data-set">Example data set<a class="anchor" aria-label="anchor" href="#example-data-set"></a>
</h2>
<p>The <strong>deweather</strong> package comes with a comprehensive
data set of air quality and meteorological data. The air quality data is
from Marylebone Road in central London (obtained from the
<a href="https://davidcarslaw.github.io/openair/" class="external-link">openair</a> package) and the meteorological data from
Heathrow Airport (obtained from the <a href="https://davidcarslaw.github.io/worldmet/index.html" class="external-link">worldmet</a>
package).</p>
<p>The <code>road_data</code> data frame contains various pollutants
such a NO<sub>x</sub>, NO<sub>2</sub>, ethane and isoprene as well as
meteorological data including wind speed, wind direction, relative
humidity, ambient temperature and cloud cover. Code to obtain this data
directly can be found <a href="https://github.com/davidcarslaw/deweather/blob/master/data-raw/road_data.R" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">road_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt;   date                  nox   no2 ethane isoprene benzene    ws    wd air_temp</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1998-01-01 <span style="color: #949494;">00:00:00</span>   546    74     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   1     280     3.6 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1998-01-01 <span style="color: #949494;">01:00:00</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   1     230     3.5 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1998-01-01 <span style="color: #949494;">02:00:00</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   1.5   180     4.25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1998-01-01 <span style="color: #949494;">03:00:00</span>   944    99     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>  <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1998-01-01 <span style="color: #949494;">04:00:00</span>   894   149     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   1.5   180     3.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1998-01-01 <span style="color: #949494;">05:00:00</span>   506    80     <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>   1     190     3.5 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: RH &lt;dbl&gt;, cl &lt;dbl&gt;</span></span></span></code></pre></div>
<p>To speed up the examples in this article we’ll randomly sample some
of <code>road_data</code>.</p>
</div>
<div class="section level2">
<h2 id="construct-and-test-models">Construct and test model(s)<a class="anchor" aria-label="anchor" href="#construct-and-test-models"></a>
</h2>
<p>The <code><a href="../reference/testMod.html">testMod()</a></code> function is used to build and test various
models to help derive the most appropriate.</p>
<p>In this example, we will restrict the data to model to 4 years. Note
that variables such as <code>"hour"</code> and <code>"weekday"</code>
are used as variables that can be used to explain some of the variation.
<code>"hour"</code> for example very usefully acts as a proxy for the
diurnal variation in emissions.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidcarslaw.github.io/openair/" class="external-link">openair</a></span><span class="op">)</span></span>
<span><span class="co"># select only part of the data set</span></span>
<span><span class="va">dat_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davidcarslaw.github.io/openair/reference/selectByDate.html" class="external-link">selectByDate</a></span><span class="op">(</span><span class="va">road_data</span>, year <span class="op">=</span> <span class="fl">2001</span><span class="op">:</span><span class="fl">2004</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to speed up the example, sample rows in `dat_part`</span></span>
<span><span class="co"># not needed in reality</span></span>
<span><span class="va">dat_part</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span><span class="va">dat_part</span>, prop <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test a model with commonly used covariates</span></span>
<span><span class="va">mod_test</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/testMod.html">testMod</a></span><span class="op">(</span></span>
<span>    <span class="va">dat_part</span>,</span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"hour"</span>, <span class="st">"weekday"</span>, <span class="st">"air_temp"</span>, <span class="st">"week"</span><span class="op">)</span>,</span>
<span>    pollutant <span class="op">=</span> <span class="st">"no2"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Optimum number of trees is <span style="font-weight: bold;">398</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> RMSE from cross-validation is <span style="font-weight: bold;">23.59</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Percent increase in RMSE using test data is <span style="font-weight: bold;">28.0%</span></span></span></code></pre></div>
<p>The output shows by default the performance of the model when applied
to a withheld random 20% (by default) of the data, i.e., the model is
evaluated against data not used to build the model. Common model
evaluation metrics are also given.</p>
</div>
<div class="section level2">
<h2 id="build-a-model">Build a model<a class="anchor" aria-label="anchor" href="#build-a-model"></a>
</h2>
<p>Assuming that a good model can be developed, it can now be explored
in more detail using the optimum number of trees from
<code><a href="../reference/testMod.html">testMod()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_no2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/buildMod.html">buildMod</a></span><span class="op">(</span></span>
<span>  <span class="va">dat_part</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trend"</span>, <span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"hour"</span>, <span class="st">"weekday"</span>, <span class="st">"air_temp"</span>, <span class="st">"week"</span><span class="op">)</span>,</span>
<span>  pollutant <span class="op">=</span> <span class="st">"no2"</span>,</span>
<span>  n.trees <span class="op">=</span> <span class="va">mod_test</span><span class="op">$</span><span class="va">optimum_trees</span>, </span>
<span>  n.core <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This function returns a <code>deweather</code> object that can be
interrogated as shown below.</p>
</div>
<div class="section level2">
<h2 id="examine-the-partial-dependencies">Examine the partial dependencies<a class="anchor" aria-label="anchor" href="#examine-the-partial-dependencies"></a>
</h2>
<div class="section level3">
<h3 id="plot-all-partial-dependencies">Plot all partial dependencies<a class="anchor" aria-label="anchor" href="#plot-all-partial-dependencies"></a>
</h3>
<p>One of the benefits of the boosted regression tree approach is that
the <em>partial dependencies</em> can be explored. In simple terms, the
partial dependencies show the relationship between the pollutant of
interest and the covariates used in the model while holding the value of
other covariates at their mean level.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPD.html">plotPD</a></span><span class="op">(</span><span class="va">mod_no2</span>, nrow <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plotAll-1.png" alt="Seven line charts showing the partial dependencies of the deweather model. In order of influence: wind direction, hour of day, long-term trend, weekday, wind speed, week of the year, and finally air temperature." width="672"><p class="caption">
The 7 partial dependencies of the deweather model.
</p>
</div>
</div>
<div class="section level3">
<h3 id="plot-two-way-interactions">Plot two-way interactions<a class="anchor" aria-label="anchor" href="#plot-two-way-interactions"></a>
</h3>
<p>It can be very useful to plot important two-way interactions. In this
example the interaction between <code>"ws"</code> and
<code>"air_temp"</code> is considered. The plot shows that
NO<sub>2</sub> tends to be high when the wind speed is low and the
temperature is low, i.e., stable atmospheric conditions. Also
NO<sub>2</sub> tends to be high when the temperature is high, which is
most likely due to more O<sub>3</sub> available to convert NO to
NO<sub>2</sub>. In fact, background O<sub>3</sub> would probably be a
useful covariate to add to the model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot2Way.html">plot2Way</a></span><span class="op">(</span><span class="va">mod_no2</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ws"</span>, <span class="st">"air_temp"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plot2way-1.png" alt="A heatmap showing the interaction between air temperature and wind speed in the deweather model. Nitrogen dioixde is shown to be high when wind speed is low and temperature is either very low or above around 25 degrees Celcius." width="50%"><p class="caption">
A two-way interaction plot showing the interaction between wind speed
and air temperature
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="apply-meteorological-averaging">Apply meteorological averaging<a class="anchor" aria-label="anchor" href="#apply-meteorological-averaging"></a>
</h2>
<p>An indication of the meteorologically-averaged trend is given by the
<code><a href="../reference/plotPD.html">plotPD()</a></code> function above, and can even be isolated using the
<code>variable</code> argument.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPD.html">plotPD</a></span><span class="op">(</span><span class="va">mod_no2</span>, variable <span class="op">=</span> <span class="st">"trend"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/pd-trend-1.png" alt="Patial dependence plot of the 'trend' component of the deweather model with date on the x-axis and NO2 on the y-axis. The trend is jagged, but shows an increase in 2003." width="672"><p class="caption">
The partial dependence plot of the ‘trend’ component.
</p>
</div>
<p>A better indication is given by using the model to predict many times
with random sampling of meteorological conditions. This sampling is
carried out by the <code><a href="../reference/metSim.html">metSim()</a></code> function. Note that in this
case there is no need to supply the <code>"trend"</code> component
because it is calculated using <code><a href="../reference/metSim.html">metSim()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metSim.html">metSim</a></span><span class="op">(</span><span class="va">mod_no2</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">dat_part</span>,</span>
<span>  metVars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ws"</span>, <span class="st">"wd"</span>, <span class="st">"hour"</span>, <span class="st">"weekday"</span>, <span class="st">"air_temp"</span>, <span class="st">"week"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now it is possible to plot the resulting trend.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://davidcarslaw.github.io/openair/reference/timePlot.html" class="external-link">timePlot</a></span><span class="op">(</span><span class="va">demet</span>, <span class="st">"no2"</span>, ylab <span class="op">=</span> <span class="st">"Deweathered no2 (ug/m3)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plotTrend-1.png" alt="A line chart with date on the x-axis and deweathered NO2 on the y-axis. The trend is very noisy, but shows an increase in concentrations in 2003." width="672"><p class="caption">
A deweathered nitrogen dioxide trend.
</p>
</div>
<p>The plot is rather noisy due to relatively few samples of meteorology
being considered (200 by default, set with <code>B = 200</code>). The
noise could be reduced by increasing the simulations, but this would add
to run time. Alternatively, it can be useful to simply average the
results. For example:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://davidcarslaw.github.io/openair/reference/timePlot.html" class="external-link">timePlot</a></span><span class="op">(</span><span class="va">demet</span>, <span class="st">"no2"</span>, avg.time <span class="op">=</span> <span class="st">"week"</span>, ylab <span class="op">=</span> <span class="st">"Deweathered no2 (ug/m3)"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="deweather_files/figure-html/plotTrendAve-1.png" alt="A line chart with date on the x-axis and deweathered NO2 on the y-axis. The trend has been time averaged to show weekly mean concentrations, clearly illustrating a sharp increase in 2003." width="672"><p class="caption">
A time-averaged deweathered nitrogen dioxide trend.
</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by David Carslaw.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
